<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Minecraft Item Atlas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fonts.cdnfonts.com/css/minecraftia">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <main class="container-fluid py-5 px-4 px-lg-5">
    <section class="page-header mb-5">
      <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
        <div>
          <h1 class="page-title mb-2">Minecraft Item Atlas</h1>
          <p class="mb-0 text-secondary">Browse blocks, tools, and curiosities straight from the Minecraft API.</p>
        </div>
        <p class="inventory-brand mb-0 px-3 py-1 rounded-3 bg-dark-subtle text-dark">Powered by minecraft-api.vercel.app</p>
      </div>
    </section>

    <section class="search-box mb-4">
      <label class="form-label mb-2" for="search">Search the inventory by name or ID</label>
      <input type="text" id="search" class="form-control form-control-lg" placeholder="Example: diamond_sword or apple">
      <p class="status-line text-center mb-0 mt-3" id="status">Loading inventory...</p>
    </section>

    <section class="type-filter mb-4">
      <div id="family-panel" class="family-panel"></div>
    </section>

    <section id="items" class="items-grid">
      <div class="placeholder">Loading items...</div>
    </section>
  </main>

  <div class="modal fade item-modal" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="itemModalLabel"></h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="modal-image-wrapper text-center mb-4">
            <img id="modal-item-image" src="" alt="" loading="lazy">
          </div>
          <p id="modal-item-meta" class="modal-meta mb-3"></p>
          <p id="modal-item-description" class="modal-description mb-0"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiLink = 'https://minecraft-api.vercel.app/api/items';
    const maxItemsLimit = 1179;

    const itemsGrid = document.getElementById('items');
    const statusText = document.getElementById('status');
    const searchField = document.getElementById('search');
    const familyTray = document.getElementById('family-panel');
    let itemList = [];
    let familyTotals = {};
    let currentFamily = 'all';
    let familyThumbs = {};
    let allThumb = '';

    const buildCard = (item) => {
      const stackInfo = item.stackSize ? `${item.stackSize} stack${item.stackSize === 1 ? '' : 's'}` : 'Unknown stack size';
      const renewableInfo = typeof item.renewable === 'boolean'
        ? (item.renewable ? 'Renewable' : 'Non-renewable')
        : 'Renewability unknown';

      return `
        <article class="item-entry">
          <div class="item-card p-4 d-flex flex-column" data-item-id="${item.namespacedId}">
            <div class="item-image-wrapper mb-4">
              <img src="${item.image}" alt="${item.name}" loading="lazy">
            </div>
            <h2 class="item-name text-uppercase text-truncate" title="${item.name}">${item.name}</h2>
            <p class="item-meta mb-2">ID: ${item.namespacedId}</p>
            <p class="flex-grow-1 mb-3">${item.description || 'No description available for this item.'}</p>
            <div class="d-flex justify-content-between flex-wrap gap-2">
              <span class="badge text-bg-success">${stackInfo}</span>
              <span class="badge text-bg-dark">${renewableInfo}</span>
            </div>
          </div>
        </article>
      `;
    };

    const renderItems = (items) => {
      if (!items.length) {
        itemsGrid.innerHTML = '<div class="placeholder">No items match your search.</div>';
        return;
      }

      const markup = items.map(buildCard).join('');
      itemsGrid.innerHTML = markup;
    };

    const updateStatus = (message) => {
      statusText.textContent = message;
    };

    const scrollToGrid = () => {
      if (!itemsGrid) {
        return;
      }
      window.requestAnimationFrame(() => {
        itemsGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    };

    const escapeHtml = (value) => {
      if (value === undefined || value === null) {
        return '';
      }
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };

    const deriveFamily = (item) => {
      const idPart = (item.namespacedId || '').split(':')[1] || item.namespacedId || '';
      const tokens = idPart.split('_').filter(Boolean);
      if (!tokens.length) {
        return 'misc';
      }
      return tokens[tokens.length - 1];
    };

    const prettifyLabel = (value) => {
      if (!value) {
        return 'Misc';
      }
      return value
        .replace(/[-_]+/g, ' ')
        .split(' ')
        .filter(Boolean)
        .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
        .join(' ');
    };

    const buildFamilyIcon = (image, label) => {
      const safeLabel = escapeHtml(label);
      if (image) {
        return `<span class="family-button__icon"><img src="${image}" alt="${safeLabel}"></span>`;
      }
      return '<span class="family-button__icon family-button__icon--fallback">?</span>';
    };

    const buildFamilyButtons = () => {
      if (!familyTray) {
        return;
      }

      const entries = Object.entries(familyTotals)
        .filter(([, count]) => count > 1)
        .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));

      const buttons = [
        `<button type="button" class="family-button${currentFamily === 'all' ? ' family-button--active' : ''}" data-family="all">${buildFamilyIcon(allThumb, 'All Items')}<span class="family-button__label">${escapeHtml(`All (${itemList.length})`)}</span></button>`
      ];

      if (!entries.length) {
        buttons.push('<span class="family-empty">No similar items to group yet.</span>');
      } else {
        entries.forEach(([key, count]) => {
          const isActive = currentFamily === key;
          const preview = familyThumbs[key] || {};
          const label = prettifyLabel(key);
          const buttonLabel = `${label} (${count})`;
          buttons.push(`<button type="button" class="family-button${isActive ? ' family-button--active' : ''}" data-family="${escapeHtml(key)}">${buildFamilyIcon(preview.image, preview.name || label)}<span class="family-button__label">${escapeHtml(buttonLabel)}</span></button>`);
        });
      }

      familyTray.innerHTML = buttons.join('');

      familyTray.querySelectorAll('[data-family]').forEach((button) => {
        button.addEventListener('click', () => {
          const selected = button.getAttribute('data-family');
          if (selected !== currentFamily) {
            currentFamily = selected;
            buildFamilyButtons();
            applyFilter();
          }
          scrollToGrid();
        });
      });
    };

    const showItemModal = (item) => {
      const modalElement = document.getElementById('itemModal');
      const modalTitle = document.getElementById('itemModalLabel');
      const modalImage = document.getElementById('modal-item-image');
      const modalMeta = document.getElementById('modal-item-meta');
      const modalDescription = document.getElementById('modal-item-description');

      modalTitle.textContent = item.name;
      modalImage.src = item.image;
      modalImage.alt = item.name;
      modalMeta.textContent = `ID: ${item.namespacedId} • Stack size: ${item.stackSize || 'Unknown'} • ${item.renewable === true ? 'Renewable' : item.renewable === false ? 'Non-renewable' : 'Renewability unknown'}`;
      modalDescription.textContent = item.description || 'No description available for this item.';

      if (window.bootstrap?.Modal) {
        showItemModal.instance = showItemModal.instance || new bootstrap.Modal(modalElement);
        showItemModal.instance.show();
      } else {
        modalElement.classList.add('show');
        modalElement.style.display = 'block';
      }
    };

    const applyFilter = () => {
      const query = searchField.value.trim().toLowerCase();
      const filtered = itemList.filter((item) => {
        const matchesFamily = currentFamily === 'all' || deriveFamily(item) === currentFamily;
        if (!matchesFamily) {
          return false;
        }

        if (!query) {
          return true;
        }

        const lowerName = item.name.toLowerCase();
        const lowerId = item.namespacedId.toLowerCase();
        return lowerName.includes(query) || lowerId.includes(query);
      });

      renderItems(filtered);
      const familyLabel = currentFamily === 'all' ? 'all families' : prettifyLabel(currentFamily);
      if (query) {
        updateStatus(`Showing ${filtered.length} of ${itemList.length} items (${familyLabel})`);
      } else {
        updateStatus(`Showing ${filtered.length} items (${familyLabel})`);
      }
    };

    const loadItems = async () => {
      searchField.disabled = true;
      try {
        updateStatus('Contacting Minecraft API...');
        const response = await fetch(apiLink);
        if (!response.ok) {
          throw new Error(`API responded with status ${response.status}`);
        }

        const data = await response.json();
        itemList = Array.isArray(data) ? data.slice(0, maxItemsLimit) : [];

        if (!itemList.length) {
          itemsGrid.innerHTML = '<div class="placeholder">No items returned by the API.</div>';
          updateStatus('No data available from the API.');
          return;
        }

        allThumb = itemList[0]?.image || '';
        familyTotals = {};
        familyThumbs = {};
        itemList.forEach((item) => {
          const family = deriveFamily(item);
          familyTotals[family] = (familyTotals[family] || 0) + 1;
          if (!familyThumbs[family]) {
            familyThumbs[family] = { image: item.image, name: item.name };
          }
        });

        buildFamilyButtons();
        applyFilter();
      } catch (error) {
        itemsGrid.innerHTML = '<div class="text-danger">Failed to load inventory. Please try again later.</div>';
        updateStatus(error.message);
        console.error('Minecraft API error:', error);
      } finally {
        searchField.disabled = false;
      }
    };

    searchField.addEventListener('input', applyFilter);
    itemsGrid.addEventListener('click', (event) => {
      const card = event.target.closest('[data-item-id]');
      if (!card) {
        return;
      }

      const itemId = card.getAttribute('data-item-id');
      const item = itemList.find((entry) => entry.namespacedId === itemId);
      if (item) {
        showItemModal(item);
      }
    });

    loadItems();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
</body>

</html>