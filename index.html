<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MineVentory</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fonts.cdnfonts.com/css/minecraftia">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <main class="container-fluid py-5 px-4 px-lg-5">
    <section class="page-header mb-5">
      <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
        <div>
          <h1 class="page-title mb-2 ">MineVentory</h1>
          <p class="mb-0 text-secondary">Browse blocks, tools, and curiosities straight from the Minecraft API.</p>
        </div>
      </div>

    </section>

    <section class="search-box mb-4">
      <label class="form-label mb-2" for="search">Search the MineVentory by name or ID</label>
      <input type="text" id="search" class="form-control form-control-lg" placeholder="Example: diamond_sword or apple">
      <p class="status-line text-center mb-0 mt-3" id="status">Loading inventory...</p>
    </section>

    <section class="type-filter mb-4">
      <div id="family-panel" class="family-panel"></div>
    </section>

    <section id="items" class="items-grid">
      <div class="placeholder">Loading items...</div>
    </section>
  </main>

  <div class="modal fade item-modal" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="itemModalLabel"></h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="modal-image-wrapper text-center mb-4">
            <img id="modal-item-image" src="" alt="" loading="lazy">
          </div>
          <p id="modal-item-meta" class="modal-meta mb-3"></p>
          <p id="modal-item-description" class="modal-description mb-0"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiLink = 'https://minecraft-api.vercel.app/api/items';
    const maxItemsLimit = 1179;

    const itemsGrid = document.getElementById('items');
    const statusText = document.getElementById('status');
    const searchField = document.getElementById('search');
    const familyTray = document.getElementById('family-panel');
    let itemList = [];
    let familyTotals = {};
    let currentFamily = 'all';
    let familyThumbs = {};
    let allThumb = '';

    function makeCard(item) {
      const stackInfo = item.stackSize ? `${item.stackSize} stack${item.stackSize === 1 ? '' : 's'}` : 'Unknown stack size';
      const renewableInfo = typeof item.renewable === 'boolean'
        ? (item.renewable ? 'Renewable' : 'Non-renewable')
        : 'Renewability unknown';

      return `
        <article class="item-entry">
          <div class="item-card p-4 d-flex flex-column" data-item-id="${item.namespacedId}">
            <div class="item-image-wrapper mb-4">
              <img src="${item.image}" alt="${item.name}" loading="lazy">
            </div>
            <h2 class="item-name text-uppercase text-truncate" title="${item.name}">${item.name}</h2>
            <p class="item-meta mb-2">ID: ${item.namespacedId}</p>
            <p class="flex-grow-1 mb-3">${item.description || 'No description available for this item.'}</p>
            <div class="d-flex justify-content-between flex-wrap gap-2">
              <span class="badge text-bg-success">${stackInfo}</span>
              <span class="badge text-bg-dark">${renewableInfo}</span>
            </div>
          </div>
        </article>
      `;
    }

    function showItems(items) {
      if (!items.length) {
        itemsGrid.innerHTML = '<div class="placeholder">No items match your search.</div>';
        return;
      }

      let cardsMarkup = '';
      for (const currentItem of items) {
        cardsMarkup += makeCard(currentItem);
      }

      itemsGrid.innerHTML = cardsMarkup;
    }

    function setStatus(message) {
      statusText.textContent = message;
    }

    function jumpToGrid() {
      if (!itemsGrid) {
        return;
      }
      window.requestAnimationFrame(() => {
        itemsGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    function cleanLabel(value) {
      if (value === undefined || value === null) {
        return '';
      }
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function getFamily(item) {
      const idPart = (item.namespacedId || '').split(':')[1] || item.namespacedId || '';
      const tokens = idPart.split('_').filter(Boolean);
      if (!tokens.length) {
        return 'misc';
      }
      return tokens[tokens.length - 1];
    }

    function niceLabel(value) {
      if (!value) {
        return 'Misc';
      }
      return value
        .replace(/[-_]+/g, ' ')
        .split(' ')
        .filter(Boolean)
        .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
        .join(' ');
    }

    function makeFamilyIcon(image, label) {
      const safeLabel = cleanLabel(label);
      if (image) {
        return `<span class="family-button__icon"><img src="${image}" alt="${safeLabel}"></span>`;
      }
      return '<span class="family-button__icon family-button__icon--fallback">?</span>';
    }

    function fillFamilyButtons() {
      if (!familyTray) {
        return;
      }

      const entries = [];
      for (const [familyName, familyCount] of Object.entries(familyTotals)) {
        if (familyCount > 1) {
          entries.push([familyName, familyCount]);
        }
      }

      entries.sort((first, second) => second[1] - first[1] || first[0].localeCompare(second[0]));

      let buttonsMarkup = `<button type="button" class="family-button${currentFamily === 'all' ? ' family-button--active' : ''}" data-family="all">${makeFamilyIcon(allThumb, 'All Items')}<span class="family-button__label">${cleanLabel(`All (${itemList.length})`)}</span></button>`;

      if (!entries.length) {
        buttonsMarkup += '<span class="family-empty">No similar items to group yet.</span>';
      } else {
        for (const [familyKey, familyCount] of entries) {
          const isActive = currentFamily === familyKey;
          const preview = familyThumbs[familyKey] || {};
          const label = niceLabel(familyKey);
          const buttonLabel = `${label} (${familyCount})`;
          buttonsMarkup += `<button type="button" class="family-button${isActive ? ' family-button--active' : ''}" data-family="${cleanLabel(familyKey)}">${makeFamilyIcon(preview.image, preview.name || label)}<span class="family-button__label">${cleanLabel(buttonLabel)}</span></button>`;
        }
      }

      familyTray.innerHTML = buttonsMarkup;

      familyTray.querySelectorAll('[data-family]').forEach((button) => {
        button.addEventListener('click', () => {
          const selected = button.getAttribute('data-family');
          if (selected !== currentFamily) {
            currentFamily = selected;
            fillFamilyButtons();
            runFilter();
          }
          jumpToGrid();
        });
      });
    }

    function openItemModal(item) {
      const modalElement = document.getElementById('itemModal');
      const modalTitle = document.getElementById('itemModalLabel');
      const modalImage = document.getElementById('modal-item-image');
      const modalMeta = document.getElementById('modal-item-meta');
      const modalDescription = document.getElementById('modal-item-description');

      modalTitle.textContent = item.name;
      modalImage.src = item.image;
      modalImage.alt = item.name;
      modalMeta.textContent = `ID: ${item.namespacedId} • Stack size: ${item.stackSize || 'Unknown'} • ${item.renewable === true ? 'Renewable' : item.renewable === false ? 'Non-renewable' : 'Renewability unknown'}`;
      modalDescription.textContent = item.description || 'No description available for this item.';

      if (window.bootstrap?.Modal) {
        openItemModal.instance = openItemModal.instance || new bootstrap.Modal(modalElement);
        openItemModal.instance.show();
      } else {
        modalElement.classList.add('show');
        modalElement.style.display = 'block';
      }
    }

    function runFilter() {
      const query = searchField.value.trim().toLowerCase();
      const filtered = [];
      for (const currentItem of itemList) {
        const matchesFamily = currentFamily === 'all' || getFamily(currentItem) === currentFamily;
        if (!matchesFamily) {
          continue;
        }

        if (!query) {
          filtered.push(currentItem);
          continue;
        }

        const lowerName = currentItem.name.toLowerCase();
        const lowerId = currentItem.namespacedId.toLowerCase();
        if (lowerName.includes(query) || lowerId.includes(query)) {
          filtered.push(currentItem);
        }
      }

      showItems(filtered);
      const familyLabel = currentFamily === 'all' ? 'all families' : niceLabel(currentFamily);
      if (query) {
        setStatus(`Showing ${filtered.length} of ${itemList.length} items (${familyLabel})`);
      } else {
        setStatus(`Showing ${filtered.length} items (${familyLabel})`);
      }
    }

    async function grabItems() {
      searchField.disabled = true;
      try {
        setStatus('Contacting Minecraft API...');
        const response = await fetch(apiLink);
        if (!response.ok) {
          throw new Error(`API responded with status ${response.status}`);
        }

        const data = await response.json();
        itemList = Array.isArray(data) ? data.slice(0, maxItemsLimit) : [];

        if (!itemList.length) {
          itemsGrid.innerHTML = '<div class="placeholder">No items returned by the API.</div>';
          setStatus('No data available from the API.');
          return;
        }

        allThumb = itemList[0]?.image || '';
        familyTotals = {};
        familyThumbs = {};
        for (const listedItem of itemList) {
          const family = getFamily(listedItem);
          familyTotals[family] = (familyTotals[family] || 0) + 1;
          if (!familyThumbs[family]) {
            familyThumbs[family] = { image: listedItem.image, name: listedItem.name };
          }
        }

        fillFamilyButtons();
        runFilter();
      } catch (error) {
        itemsGrid.innerHTML = '<div class="text-danger">Failed to load inventory. Please try again later.</div>';
        setStatus(error.message);
        console.error('Minecraft API error:', error);
      } finally {
        searchField.disabled = false;
      }
    }

    searchField.addEventListener('input', runFilter);
    itemsGrid.addEventListener('click', (event) => {
      const card = event.target.closest('[data-item-id]');
      if (!card) {
        return;
      }

      const itemId = card.getAttribute('data-item-id');
      const item = itemList.find((entry) => entry.namespacedId === itemId);
      if (item) {
        openItemModal(item);
      }
    });

    grabItems();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
</body>

</html>